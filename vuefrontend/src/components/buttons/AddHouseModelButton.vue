<template>
  <div class="d-inline-block">
    <button class="btn btn-outline-secondary btn-sm ms-1" type="button"
            @click="openModal" :disabled="isDisabled">
      <img src="@assets/img/icon-addlink.svg" alt="Add House Model" width="15" height="15">
    </button>

    <HouseModelModal
      ref="houseModelModal"
      :action="'add'"
      :builderId="props.builderId"
      @saved="handleSaved"
      @refresh="handleRefresh"
      @close="closeModal"
    />
  </div>
</template>

<script setup>
import { ref, defineProps, defineEmits } from 'vue'
import HouseModelModal from '@components/contracts/HouseModelModalComponent.vue'
import axios from 'axios'

const props = defineProps({
  isDisabled: Boolean,
  jobId: { type: [Number, String, Array, null], default: null },
  builderId: { type: [Number, String, null], default: null }, 
})

const emit = defineEmits(['housemodel-added'])

const houseModelModal = ref(null)
const action = ref('add')

async function openModal() {
  action.value = 'add'
  await houseModelModal.value?.showModal()
}

function closeModal() {
  houseModelModal.value?.hideModal()
  document.querySelectorAll('.modal-backdrop').forEach(el => el.remove())
}

function handleSaved() {
  axios.get('/api/house_model/')
    .then(response => {
      const houseList = response.data
      const newest = houseList.reduce((a, b) => a.id > b.id ? a : b)
      emit('housemodel-added', { houseModel: newest, list: houseList })
    })
    .catch(error => {
      console.error('Error fetching house models:', error)
    })
}

async function handleRefresh() { /* noop o reusar handleSaved si quieres */ }
</script>
